---
title: "Script for the third report"
output: html_notebook
---
# 概述
針對第三次期中報告的資料整合，第三次期中報告是針對職務進行資料整合與分析
# 0. package
```{r,echo=FALSE}
library(data.table)
library(stringr)
library(readxl)
path <- "H:/我的雲端硬碟/研究室計畫/2022/雪霸報告/第三次期中報告"
data_path <- "E:/雪霸報告統整"
```
# 1.資料庫資料整合
整合雪霸相關資料庫，並進行資料合併

## 1.1 雪霸資料庫
說明：資料來源由政道老師爬資料庫取得
資料庫來源(http://spnp.biodiv.tw)
由於舊資料庫有自己的編號方式，與雪霸給的計畫ID不同。
因此必須輸出資料庫內的ID-調查年，然後手動查詢實際計畫id，並建立計畫id對應表。
計畫ID對應表已在第一次期中報告完成。
並輸出植物類與真菌類資料
預計篩選者有：
Magnoliopsida(木蘭綱)、Pinopsida(松綱)、Equisetopsida(木賊綱)Liliopsida(百合綱)、Lycopodiopsida(石松綱)、Bryopsida(苔綱)、Jungermanniopsida(葉蘚綱)
```{r}
spnp_dt <- fread(paste0(path,"/rawdata/spnp_雪霸舊資料庫/spnp_occurrences.csv"),encoding ="UTF-8")
pcode_com <- fread(paste0(path,"/rawdata/spnp_雪霸舊資料庫/雪霸舊資料庫id對照表.csv"))
spnp <- spnp_dt[pcode_com,on=.(projectId.x,`調查年`)]
setnames(spnp,"fit_id","id")
write.csv(spnp,paste0(path,"/rawdata/雪霸舊資料庫_計畫id更新.csv"))##輸出備份
spnp[,c("X","Y"):=.(decimalLongitude.x,decimalLatitude.x)]
spnp[,座標系統:="EPSG:4326"]
class <- unique(spnp[,class])
write.csv(class,paste0(path,"/rawdata/class_check.csv"))
spnp_pl <- spnp[class %in% c("Magnoliopsida","Pinopsida",
                              "Equisetopsida","Liliopsida",
                              "Lycopodiopsida","Bryopsida",
                              "Jungermanniopsida")]
### 將資料切分成名錄所需以及database
spnp_list <- spnp_pl[,.(phylum,class,order,family,scientificName,vernacularName)]
spnp_list <- unique(spnp_list)
colnames(spnp_pl)
spnp_pl <- spnp_pl[,33:50]
write.csv(spnp_pl,paste0(path,"/result/data_base/database_prim_spnp_old_data.csv"))
write.csv(spnp_list,paste0(path,"/result/name_list/name_list_prim_spnp_old_data.csv"))

rm(spnp,spnp_dt,pcode_com)
```
## 1.2 處理武陵新資料庫
資料來自於武陵新的資料庫
http://wlterm.biodiv.tw/
由於與舊資料庫部分重疊，因此採用2018年(含)以後的資料
武陵的新資料庫沒有植物資料故省略

## 1.3 處理國家公園資料庫

處理國家公園資料庫
處理`20211115_雪霸國家公園調查成果資料(110年更新).xlsx`檔案
該資料有大量來自於非雪霸國家公園之資料

```{r}
ntb <- fread(paste0(path,"/rawdata/國家公園資料庫建置計畫/20211115_雪霸國家公園調查成果資料.csv"),encoding="UTF-8")
head(ntb)
colnames(ntb)
ntb[,date:=as.Date(as.character(`調查日期`),format ="%Y%m%d")]
colnames(ntb)
ntb[,c("id","調查年","調查日期","生物分群",
        "綱","X","Y","wkt","座標系統",
        "位置誤差","樣區編號","調查方法",
        "分類階層","科名(原始報告)","科名",
        "物種俗名(原始報告)","物種學名(原始報告)",
        "物種學名","生活史","數量","數量單位","備註"):=
       .(id,year(date),date,NA,`分類名稱`,經度,
         緯度,NA,"EPSG:4326",不準度,NA,NA,鑑定層級,
         NA,NA,中文俗名,學名,NA,
         NA,數量,數量單位,備註)]
ntb_database <- ntb[,c("id","調查年","調查日期","生物分群",
        "綱","X","Y","wkt","座標系統",
        "位置誤差","樣區編號","調查方法",
        "分類階層","科名(原始報告)","科名",
        "物種俗名(原始報告)","物種學名(原始報告)",
        "物種學名","生活史","數量","數量單位",
        "備註","座標是否有模糊化","TaiCoL物種代碼")]
unique(ntb_database[,綱])
ntb_plan <- ntb_database[綱 %in% c("石松綱","百合綱","木蘭綱",
                                  "松綱","真蕨綱","蘚綱","木賊綱")]
n_list <- unique(ntb_plan[,.(`物種俗名(原始報告)`,`物種學名(原始報告)`,TaiCoL物種代碼)])
write.csv(ntb_plan,paste0(path,"/result/data_base/database_prim_國家公園資料庫.csv"))
write.csv(n_list ,paste0(path,"/result/name_list/name_list_prim_國家公園資料庫.csv"))
rm(ntb,ntb_database)
```

## 1.4 處理數化資料
讀取資料夾中的數化資料夾，並進行資料合併
```{r}
file_name <- list.files(paste0(data_path,"/植物"))
dig_data <- lapply(file_name,function(x){
  tryCatch({
             dt <-as.data.table( read_xlsx(paste0(data_path,
                                                  "/植物/",x
                                                  ,"/",x,".xlsx"),1))
            }, error =function(x){
              print(x)
            })
    return(dt)
})
## 手動處理沒辦法加入之報告
###分別有9,30,31

{dig_data[[9]]<-as.data.table( read_xlsx("E:/雪霸報告統整/植物/10704_雪山及南湖山區高山植物之遺傳分化－以南湖柳葉菜、雪山馬蘭及南湖碎雪草為例/10704_雪山及南湖山區高山植物之遺傳分化－以南湖柳葉菜、雪山馬蘭及南湖碎雪草為例.xlsx")) 
dig_data[[30]]<-as.data.table( read_xlsx("E:/雪霸報告統整/植物/9411_雪霸國家公園珍貴原生植物之育種研究-棣慕華鳳仙花物候調查及族群遺傳分子親緣的研究/9411_雪霸國家公園珍貴原生植物之育種研究-棣慕華鳳仙花物候調查及族群遺傳分子親緣的研究.xlsx")) 
dig_data[[31]]<-as.data.table( read_xlsx("E:/雪霸報告統整/植物/9502_雪霸國家公園珍貴原生植物之育種研究－鳳仙花植物復育及族群遺傳分子親緣的研究/9502_雪霸國家公園珍貴原生植物之育種研究－鳳仙花植物復育及族群遺傳分子親緣的研究.xlsx")) }
### 確認ID的正確性
pro_id <- lapply(file_name,function(x){
  str_split_fixed(x,"_",2)[1]})
unlist(pro_id)
id_match <- lapply(dig_data,function(x){
  id <- unique(x[,id])
})
id_check <- data.table(as.numeric(unlist(pro_id)),as.numeric(unlist(id_match)))
id_check[,id_c:=V1-V2]
id_check[id_c!=0]
rm(pro_id,id_match,id_check)
### 整合資料
dig_data <-lapply(dig_data,function(x){
  x[,調查日期:=as.character(調查日期)]
  })
dig_data_all <- rbindlist(dig_data,fill=TRUE)
dig_data_all[生物分群=="植物",生物分群:="植物類"]
dig_data_all[生物分群=="真菌",生物分群:="真菌類"]
unique(dig_data_all[,生物分群])
dig_name_list <- unique(dig_data_all[,.(生物分群,`物種俗名(原始報告)`)])
write.csv(dig_name_list,paste0(path,"/result/name_list/dig_namelist.csv"))
rm(dig_data)
```
## 1.5 處理整合後的學名
將中文名與TaiCol中文名比對，並以accept code 作為合併依據
```{r}
o_list <- fread(paste0(path,"/result/name_list/其他報告名錄整合.csv"))
dig_name_list <- fread(paste0(path,"/result/name_list/dig_namelist.csv"))

colnames(dig_name_list)[2:3] <- c("class","species")
colnames(n_list) <- c("speceis_org","sci_name_org","tai_code")
colnames(spnp_list)
setnames(spnp_list,"vernacularName","name")
## ntb的資料本身有taicol的編號，故另外處理
t_nl <- rbind(o_list[,.(species_r)],dig_name_list[,.(species)],spnp_list[,.(name)],use.names=FALSE)
t_nl <- unique(t_nl)
### 載入taicol名錄
taicol <- fread(paste0(path,"/rawdata/名錄_TaiCol/TaiCOL_name_20230325.csv"),
                encoding="UTF-8")
colnames(taicol)
n_check <- taicol[usage_status=="accepted",.(common_name_c,rank,taxon_id)][t_nl,
                on=.(common_name_c=species_r)]
n_check <- n_check[common_name_c!=""]
unknow_n <- n_check[is.na(taxon_id)]
### 處理一些明顯的文字問題
t_nl[,r_sp_n:=species_r]
t_nl[grep("台灣",species_r),r_sp_n:=gsub("台灣","臺灣",r_sp_n)]
t_nl[grep("莢<U\\+84BE>",species_r),r_sp_n:=gsub("莢<U\\+84BE>","莢蒾",r_sp_n)]
t_nl[grep("莢迷",species_r),r_sp_n:=gsub("莢迷","莢蒾",r_sp_n)]
t_nl[,r_sp_n:=gsub("莢蒾迷","莢蒾",r_sp_n)]
t_nl[grep("菝",species_r),r_sp_n:=gsub("菝.","菝葜",r_sp_n)]
t_nl[grep("菝<U\\+845C>",species_r),r_sp_n:=gsub("菝葜U\\+845C>","菝葜",r_sp_n)]
t_nl[grep("拔契",species_r),r_sp_n:=gsub("拔契","菝葜",r_sp_n)]
t_nl[grep("莢<U\\+84BE>",species_r),r_sp_n:=gsub("莢<U\\+84BE>","莢蒾",r_sp_n)]
t_nl[,r_sp_n:=gsub("(臺灣<U\\+6AAB>樹|臺灣擦樹)","臺灣檫樹",r_sp_n)]
t_nl[,r_sp_n:=gsub("水苦<U\\+8552>","水苦蕒",r_sp_n)]
t_nl[,r_sp_n:=gsub("水苦$","水苦蕒",r_sp_n)]
t_nl[,r_sp_n:=gsub("水苦.","水苦蕒",r_sp_n)]
t_nl[,r_sp_n:=gsub("<U\\+00A0>","",r_sp_n)]
t_nl[grep("-",species_r),r_sp_n:=gsub("-","",r_sp_n)]
#### 加入文字對應

### 重新比對學名
n_check <- taicol[usage_status=="accepted",.(common_name_c,rank,taxon_id)][t_nl,
                on=.(common_name_c=r_sp_n)]
n_check <- n_check[common_name_c!=""]
unknow_n <- n_check[is.na(taxon_id)]

writexl::write_xlsx(unknow_n,paste0(path,"/result/name_list/name_recheck.xlsx"))
```

